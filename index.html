import React, { useState, useEffect } from 'react';
import { Search, Image as ImageIcon, Terminal, Database, BookOpen, Clipboard, Play, AlertCircle, FileText } from 'lucide-react';

const App = () => {
  const API_BASE = "https://api.gatcg.com";
  const IMAGE_BASE = "https://api.gatcg.com/cards/images";

  // 默认导入范例文本
  const defaultDeckText = `# Material Deck
1 Spirit of Water
1 Diao Chan, Enchantress
1 Backup Charger
1 Enfeebling Orb

# Main Deck
4 Fractal of Insight
4 Shimmering Refraction
4 Burst Asunder
4 Frostsworn Paladin

# Sideboard
1 Censer of Restful Peace
1 Nullifying Mirror

# https://silv.ie/deck/order-censer-random/6`;

  const [rawInput, setRawInput] = useState(defaultDeckText);
  const [decks, setDecks] = useState({ material: [], main: [], side: [] });
  const [activeCard, setActiveCard] = useState(null);
  const [activeImageUrl, setActiveImageUrl] = useState("");
  const [imageStatus, setImageStatus] = useState('idle');
  const [logs, setLogs] = useState([]);

  // 日志记录
  const addLog = (msg, type = 'info', detail = "") => {
    setLogs(prev => [{
      time: new Date().toLocaleTimeString(),
      msg,
      detail,
      type
    }, ...prev].slice(0, 15));
  };

  // 解析 Omnidex 格式文本
  const parseDecklist = (text) => {
    const lines = text.split('\n');
    const material = [];
    const main = [];
    const side = [];
    let currentSection = null;

    lines.forEach(line => {
      const trimmed = line.trim();
      if (!trimmed || trimmed.startsWith('https://')) return;

      if (trimmed.startsWith('#')) {
        const header = trimmed.toLowerCase();
        if (header.includes('material')) currentSection = 'material';
        else if (header.includes('main')) currentSection = 'main';
        else if (header.includes('side')) currentSection = 'side';
        return;
      }

      // 提取数量和名称 (例如 "4 Fractal of Insight" -> count: 4, name: "Fractal of Insight")
      const match = trimmed.match(/^(\d+)\s+(.+)$/);
      if (match && currentSection) {
        const entry = { count: parseInt(match[1]), name: match[2] };
        if (currentSection === 'material') material.push(entry);
        else if (currentSection === 'main') main.push(entry);
        else if (currentSection === 'side') side.push(entry);
      }
    });

    setDecks({ material, main, side });
    addLog(`解析成功: Material(${material.length}), Main(${main.length}), Side(${side.length})`, 'success');
  };

  // 核心检索逻辑 (包含路径去重修正)
  const fetchCardImage = async (cardName) => {
    setActiveCard(cardName);
    setImageStatus('searching');
    addLog(`正在检索卡牌: ${cardName}`);

    try {
      const searchUrl = `${API_BASE}/cards/search?name=${encodeURIComponent(cardName)}`;
      const response = await fetch(searchUrl);
      const result = await response.json();

      if (!result.data || result.data.length === 0) {
        throw new Error("API 未找到此卡牌");
      }

      const card = result.data[0];
      const rawImage = card.editions?.[0]?.image;

      if (!rawImage) throw new Error("此卡牌无图像字段");

      // 路径去重逻辑：提取最后的文件名
      const fileName = rawImage.includes('/') ? rawImage.split('/').pop() : rawImage;
      const finalUrl = `${IMAGE_BASE}/${fileName}`;

      addLog(`找到文件: ${fileName}`, 'success', finalUrl);
      setActiveImageUrl(finalUrl);
      setImageStatus('loading');
    } catch (err) {
      addLog(`错误: ${err.message}`, 'error');
      setImageStatus('error');
    }
  };

  // 初始解析
  useEffect(() => {
    parseDecklist(rawInput);
  }, []);

  return (
    <div className="min-h-screen bg-[#0d0d0f] text-[#ced4da] font-sans p-4 lg:p-8">
      <header className="max-w-7xl mx-auto mb-8 flex items-center justify-between border-b border-white/5 pb-6">
        <div>
          <h1 className="text-2xl font-black text-white flex items-center gap-3">
            <BookOpen className="text-indigo-500" />
            Omnidex Deck 导入与诊断系统
          </h1>
          <p className="text-gray-500 text-xs mt-1 font-mono uppercase tracking-widest italic text-indigo-400">Standard: GATCG Omnidex Import Pattern</p>
        </div>
        <div className="hidden md:block text-[10px] font-mono text-gray-600 bg-white/5 px-3 py-1 rounded">
          STATUS: READY_FOR_IMPORT
        </div>
      </header>

      <main className="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-6">
        
        {/* 左侧：输入与解析列表 (5列) */}
        <section className="lg:col-span-5 space-y-6">
          <div className="bg-[#16161a] p-5 rounded-xl border border-white/5 shadow-2xl">
            <h2 className="text-xs font-bold text-gray-500 uppercase mb-4 flex items-center gap-2">
              <Clipboard size={14} /> 粘贴 Decklist
            </h2>
            <textarea 
              value={rawInput}
              onChange={(e) => setRawInput(e.target.value)}
              className="w-full h-48 bg-[#1c1c21] border border-white/10 rounded-lg p-3 text-xs font-mono text-gray-300 focus:ring-1 focus:ring-indigo-500 outline-none resize-none"
              placeholder="# Material Deck..."
            />
            <button 
              onClick={() => parseDecklist(rawInput)}
              className="w-full mt-3 bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-lg text-xs font-bold transition flex items-center justify-center gap-2"
            >
              <Play size={14} /> 导入并解析
            </button>
          </div>

          {/* 解析后的结果展示 */}
          <div className="bg-[#16161a] p-5 rounded-xl border border-white/5 max-h-[500px] overflow-y-auto space-y-6">
            <DeckSection title="Material Deck" cards={decks.material} onCardClick={fetchCardImage} activeCard={activeCard} color="text-indigo-400" />
            <DeckSection title="Main Deck" cards={decks.main} onCardClick={fetchCardImage} activeCard={activeCard} color="text-green-400" />
            <DeckSection title="Sideboard" cards={decks.side} onCardClick={fetchCardImage} activeCard={activeCard} color="text-yellow-400" />
          </div>
        </section>

        {/* 右侧：预览与日志 (7列) */}
        <section className="lg:col-span-7 grid grid-cols-1 md:grid-cols-2 gap-6">
          
          {/* 图像预览 */}
          <div className="bg-[#16161a] p-5 rounded-xl border border-white/5 flex flex-col min-h-[500px]">
            <h2 className="text-xs font-bold text-gray-500 uppercase mb-4 flex items-center gap-2">
              <ImageIcon size={14} /> 卡牌预览
            </h2>
            <div className="flex-1 bg-black rounded-lg relative overflow-hidden flex items-center justify-center border border-white/5">
              {(imageStatus === 'searching' || imageStatus === 'loading') && (
                <div className="absolute inset-0 bg-black/60 z-20 flex items-center justify-center">
                  <div className="w-8 h-8 border-2 border-indigo-500/20 border-t-indigo-500 rounded-full animate-spin"></div>
                </div>
              )}
              {activeImageUrl && (
                <img 
                  key={activeImageUrl}
                  src={activeImageUrl}
                  alt="预览"
                  className={`max-w-full h-auto object-contain transition-opacity duration-300 ${imageStatus === 'loaded' ? 'opacity-100' : 'opacity-0'}`}
                  onLoad={() => setImageStatus('loaded')}
                  onError={() => {
                    setImageStatus('error');
                    addLog("渲染失败: 404", 'error', activeImageUrl);
                  }}
                />
              )}
              {!activeImageUrl && imageStatus === 'idle' && (
                <div className="text-gray-800 text-center p-8">
                  <ImageIcon size={48} className="mx-auto mb-2 opacity-10" />
                  <p className="text-[10px] uppercase font-mono tracking-widest">请选择一张卡牌预览</p>
                </div>
              )}
            </div>
            {activeImageUrl && (
              <div className="mt-4 p-3 bg-black/40 rounded border border-white/5">
                <p className="text-[9px] text-gray-600 mb-1 font-bold">REQ_URL (已修正):</p>
                <p className="text-[10px] font-mono text-indigo-300 break-all select-all">{activeImageUrl}</p>
              </div>
            )}
          </div>

          {/* 实时诊断日志 */}
          <div className="bg-[#16161a] rounded-xl border border-white/5 flex flex-col overflow-hidden h-[500px]">
            <div className="bg-white/5 px-4 py-3 border-b border-white/5 flex justify-between items-center text-xs font-bold text-gray-500">
              <Terminal size={14} /> 链路日志
            </div>
            <div className="flex-1 overflow-y-auto p-4 space-y-3 font-mono text-[10px]">
              {logs.map((log, i) => (
                <div key={i} className={`p-2 rounded border-l-2 ${
                  log.type === 'error' ? 'bg-red-500/5 border-red-500 text-red-400' : 
                  log.type === 'success' ? 'bg-green-500/5 border-green-500 text-green-400' : 
                  'bg-white/5 border-indigo-500/20 text-gray-400'
                }`}>
                  <div className="flex justify-between mb-1">
                    <span className="font-bold">{log.msg}</span>
                    <span className="opacity-40">{log.time}</span>
                  </div>
                  {log.detail && <div className="break-all opacity-50 mt-1 select-all">{log.detail}</div>}
                </div>
              ))}
            </div>
          </div>

        </section>
      </main>

      <footer className="max-w-7xl mx-auto mt-8 py-6 border-t border-white/5 text-center text-[10px] text-gray-700 font-mono">
         | ENDPOINT: api.gatcg.com
      </footer>
    </div>
  );
};

// 子组件：卡组列表展示
const DeckSection = ({ title, cards, onCardClick, activeCard, color }) => {
  if (cards.length === 0) return null;
  return (
    <div>
      <h3 className={`text-[10px] font-black uppercase tracking-widest mb-3 ${color} border-b border-white/5 pb-1`}>
        {title} ({cards.reduce((acc, c) => acc + c.count, 0)})
      </h3>
      <div className="space-y-1">
        {cards.map((card, i) => (
          <button 
            key={i}
            onClick={() => onCardClick(card.name)}
            className={`w-full text-left px-2 py-1.5 rounded text-[11px] flex items-center justify-between transition group ${
              activeCard === card.name ? 'bg-indigo-500/20 text-white' : 'hover:bg-white/5 text-gray-400'
            }`}
          >
            <span className="truncate flex items-center gap-2">
              <span className="text-gray-600 font-bold w-4">{card.count}</span>
              {card.name}
            </span>
            <Search size={10} className="opacity-0 group-hover:opacity-100 transition" />
          </button>
        ))}
      </div>
    </div>
  );
};

export default App;
