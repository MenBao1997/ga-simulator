<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Grand Archive 开发调试 - 最终版</title>
    <style>
        body { font-family: sans-serif; background: #222; color: #fff; text-align: center; padding: 40px; }
       .debug-panel { background: #333; padding: 20px; border-radius: 10px; max-width: 500px; margin: 0 auto; border: 1px solid #44k; }
        input { padding: 10px; width: 60%; border-radius: 5px; border: none; }
        button { padding: 10px 20px; border-radius: 5px; border: none; background: #e91e63; color: white; cursor: pointer; }
        img { max-width: 320px; border-radius: 15px; margin-top: 20px; display: none; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
       .log { margin-top: 20px; font-size: 12px; color: #aaa; text-align: left; background: #000; padding: 10px; }
    </style>
</head>
<body>

    <div class="debug-panel">
        <h3>卡牌 API 深度调试</h3>
        <input type="text" id="cardName" placeholder="输入英文名 (如: Rai)">
        <button onclick="debugSearch()">搜索并加载</button>
        
        <div id="status">等待指令...</div>
        <img id="display" src="">
        
        <div class="log" id="log">日志: 准备就绪</div>
    </div>

    <script>
        function addLog(msg) {
            const logDiv = document.getElementById('log');
            logDiv.innerHTML += `<br>> ${msg}`;
        }

        async function debugSearch() {
            const name = document.getElementById('cardName').value;
            const status = document.getElementById('status');
            const img = document.getElementById('display');
            
            if (!name) return;
            addLog(`正在搜索: ${name}...`);
            status.innerText = "请求中...";

            try {
                // 使用 allorigins 代理
                const api = `https://api.gatcg.com/cards/search?name=${encodeURIComponent(name)}`;
                const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(api)}`);
                const data = await response.json();
                const result = JSON.parse(data.contents);

                if (result.data && result.data.length > 0) {
                    const card = result.data;
                    // 核心修复：editions 是数组，必须加 
                    if (card.editions && card.editions.length > 0) {
                        const fileName = card.editions.image;
                        const imageUrl = `https://api.gatcg.com/cards/images/${fileName}?rounded=true`;
                        
                        addLog(`找到卡牌: ${card.name}, 图片名: ${fileName}`);
                        img.src = imageUrl;
                        img.onload = () => {
                            img.style.display = "block";
                            status.innerText = "加载成功！";
                        };
                        img.onerror = () => {
                            addLog("错误: 图片地址存在但无法下载，请检查 VPN。");
                            status.innerText = "图片被网络拦截";
                        };
                    }
                } else {
                    status.innerText = "未找到卡牌";
                    addLog("API 返回结果为空。");
                }
            } catch (err) {
                addLog(`系统错误: ${err.message}`);
                status.innerText = "搜索失败";
            }
        }
    </script>
</body>
</html>
